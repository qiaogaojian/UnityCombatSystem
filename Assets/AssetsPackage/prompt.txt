?????? C# ? Unity3d ?????????, ?????????????, ???????????????????, (??:1.????????(???#,???)?????????? 2.??????????? 3.???????????, ???????, ???????????:?????? Weapon ??????????? Sword ? Gun????? Weapon ????????????? Attack ?????????????????????????????????? Attack ?? 4.??????????? 5.??????,?????? 6.??????????,???????500???)
????????????:
?????????????, ?????????????, ???????, ???????????
using System.Collections;
using System.Collections.Generic;
using UnityEngine;

public class GameApp : MonoBehaviour
{
    public static GameApp Instance = null;
    public void Init() {
        GameApp.Instance = this;
        new GM_EffectMgr().Init();
        new GM_SkillMgr().Init();
        new GM_BuffMgr().Init();

        EventMgr.Instance.AddListener((int)GM_Event.UI, this.OnUIEventProc);
    }

    private void OnUIEventProc(int eventType, object udata, object param = null)
    {
        switch ((int)udata)
        {
            case (int)UIEvent.Skill:
                FightMgr.Instance.OnProcessSkill((int)param);
                break;
            case (int)UIEvent.Buff:
                FightMgr.Instance.OnProcessBuff((int)param);
                break;
        }

    }

    public void EnterGame() {
        // ??UI
        var canvas = GameObject.Find("Canvas");
        GameObject fightUiPrefab = ResMgr.Instance.LoadAssetSync<GameObject>("GUI/Prefabs/FightUI.prefab");
        var fightUi = GameObject.Instantiate(fightUiPrefab);
        fightUi.name = fightUiPrefab.name;
        fightUi.transform.SetParent(canvas.transform, false);
        fightUi.AddComponent<FightUICtrl>().Init();
        // end

        // ????????
        var gameObject = new GameObject();
        gameObject.name = "FightRoot";
        gameObject.AddComponent<FightMgr>().Init();
        FightMgr.Instance.LoadAndGotoMap(10001);
        // end
    }
}
using System.Collections;
using System.Collections.Generic;
using UnityEngine;

public class FightMgr : MonoBehaviour
{
    public static FightMgr Instance = null;

    // ???????,
    private GM_Charactor player = null;
    private GM_Charactor enemy = null;
    // end

    public void Init() {
        FightMgr.Instance = this;
    }

    public void LoadAndGotoMap(int mapId) {
        // ????????
        GameObject mapPrefab = ResMgr.Instance.LoadAssetSync<GameObject>($"Maps/Prefabs/{mapId}.prefab");
        var map = GameObject.Instantiate(mapPrefab);
        map.name = mapPrefab.name;
        map.transform.SetParent(this.transform, false);
        // end

        // ?????? self
        GameObject selfPrefab = ResMgr.Instance.LoadAssetSync<GameObject>($"Charactors/Prefabs/Self/20001.prefab");
        var self = GameObject.Instantiate(selfPrefab);
        self.name = "B_20001";
        self.transform.SetParent(this.transform, false);
        Vector3 pos = self.transform.position;
        pos.x -= 3;
        self.transform.position = pos;
        self.transform.LookAt(new Vector3(1, 0, 0));

        this.player = self.AddComponent<GM_Charactor>();
        this.player.Init(20001, true);
        // end

        // ?????? other
        GameObject enemyPrefab = ResMgr.Instance.LoadAssetSync<GameObject>($"Charactors/Prefabs/Enemy/20001.prefab");
        var enemy = GameObject.Instantiate(enemyPrefab);
        enemy.name = "R_20001";
        enemy.transform.SetParent(this.transform, false);
        pos = enemy.transform.position;
        pos.x += 3;enemy.transform.position = pos;
        enemy.transform.position = pos;
        enemy.transform.LookAt(new Vector3(-1, 0, 0));

        this.enemy = enemy.AddComponent<GM_Charactor>();
        this.enemy.Init(20001, false);
        // end

    }

    public void OnProcessBuff(int buffId/*, int uid*/) {
        this.player.StartBuff(buffId);
    }

    public void OnProcessSkill(int skillId/*, int uid*/)
    {
        this.player.StartSkill(skillId);
    }

    public GM_Charactor[] FindTargetsInArea(GM_Charactor center, float attackR)
    {
        // ????????buff,?????attackR;
        // end

        // test
        if (this.player == center)
        {
            return new GM_Charactor[] { this.enemy };
        }
        else
        {
            return new GM_Charactor[] { this.player };
        }
    }
}
using System.Collections;
using System.Collections.Generic;
using UnityEngine;

// buf ????;
public class FightCalcResult
{
    public float attack;
    public float defense;

    // ?????????????; ...
    public float attackR;
}

// ??????;
public class GM_Charactor : MonoBehaviour
{
    public UserInfoData userData;
    public AnimData ch;
    public FightData fightData;

    public SkillTimeLine skillTimeLine;
    public BuffTimeLine buffTimeLine;

    private bool isSelf = false;

    public void Init(int charactorId, bool isSelf)
    {
        this.userData.Init(charactorId);
        this.ch.Init(this);
        this.fightData.Init(ref this.userData);
        this.skillTimeLine.Init();
        this.buffTimeLine.Init();

        this.isSelf = isSelf;
        this.SetState(CharactorState.Idle);

        // test,??????????????
        EventMgr.Instance.Emit((int)GM_Event.UI, this.isSelf ? UIEvent.SyncSelfHp : UIEvent.SyncEnemyHp, this.fightData.hp);
        // end
    }

    public void SetState(CharactorState state) {
        this.ch.SetState(state);
    }

    public void StartBuff(int buffId)
    {
        if (this.buffTimeLine.StartBuff(buffId))
        {
            // test, ??UI?Buff????
            EventMgr.Instance.Emit((int)GM_Event.UI, UIEvent.BuffOpened);
        }
    }

    public void StartSkill(int skillId)
    {
        if (this.skillTimeLine.StartSkill(this, skillId, () =>
        {
            this.ch.SetState(CharactorState.Idle);
        }))
        {
            this.ch.SetState(CharactorState.Attack);
        }

    }

    public void OnLoseHp(int loseHp)
    {

        this.fightData.hp -= loseHp;


        if (this.fightData.hp <= 0)
        {
            this.fightData.hp = 0;
            this.SetState(CharactorState.Died);
        }

        Debug.Log($"Last HP: {this.fightData.hp}");
        EventMgr.Instance.Emit((int)GM_Event.UI, this.isSelf ? UIEvent.SyncSelfHp : UIEvent.SyncEnemyHp, this.fightData.hp);
    }

    public void CalcFightBuff(string propName, FightCalcResult ret) {
        this.buffTimeLine.CalcAllBuffsWithProp(propName, ret);
    }

    public void Update() {
        this.skillTimeLine.OnUpdate(Time.deltaTime);
        this.buffTimeLine.OnUpdate(Time.deltaTime);
    }
}
using System;
using System.Collections;
using System.Collections.Generic;
using System.Reflection;
using UnityEngine;


// ???????????????????;
public class SkillTimePoint {
    public float exceTime; // ?????????????????????????;
    public MethodInfo exceProc; // ????????;

    public SkillTimePoint(float exceTime, MethodInfo exceProc) {
        this.exceTime = exceTime;
        this.exceProc = exceProc;
    }
}

public class SkillTimeNode {
    public float runTime; // ?????????,  ???--->??? or ?????;
    public bool isExced; // ?????????;
    public object udata; // ?????????????????;

    public SkillTimePoint timePoint; // ??????;

    public SkillTimeNode(SkillTimePoint pt) {
        this.timePoint = pt;
        this.runTime = timePoint.exceTime;
        this.isExced = false;
        this.udata = null;
    }

}

// ????: ?????????;  --->?????????????????????????????;
// ?????????????????,???????BuffTimeLine;

public struct SkillTimeLine {
    private List<SkillTimeNode> timelineNode; // ??Time?????;
    public GM_Charactor sender;
    public int skillId;


    private bool isRunning; // ?????State ??,??Buff????;
    private Action OnComplete; // ?????????;

    public void Init() {
        this.timelineNode = null;
        this.isRunning = false;
        this.sender = null;
        this.skillId = 0;
    }

    public bool StartSkill(GM_Charactor sender, int skillId, Action OnComplete)
    {
        if (this.isRunning) {
            return false;
        }
        this.timelineNode = null;

        List<SkillTimeNode> timeLine = GM_SkillMgr.Instance.GetSkillTimeNode(skillId);
        if (timeLine == null) {
            return false;
        }

        this.timelineNode = timeLine;
        this.isRunning = true;
        this.OnComplete = OnComplete;

        this.skillId = skillId;
        this.sender = sender;

        return true;
    }

    public void OnUpdate(float dt) {
        if (this.isRunning == false) {
            return;
        }

        if (this.timelineNode == null) {
            this.isRunning = false;
            return;
        }

        bool endFlag = true;
        // ?????timeNode,??????????
        for (int i = 0; i < this.timelineNode.Count; i++) {
            if (this.timelineNode[i].isExced) {
                continue;
            }

            this.timelineNode[i].runTime -= dt;
            if (this.timelineNode[i].runTime <= 0) {
                this.timelineNode[i].isExced = true;

                object[] paramData = new object[] { this.sender, this.skillId, this.timelineNode[i].udata };
                this.timelineNode[i].timePoint.exceProc.Invoke(null, paramData);
            }

            endFlag = false;
        }

        // ????????????????????????????BuffTimeLine?????????????????????????;
        if (endFlag) {  // ??????????????????;  ???????,?????;
            this.isRunning = false;
            this.timelineNode = null;
            if (this.OnComplete != null) {
                this.OnComplete();
            }
        }
    }
}


using System;
using System.Collections;
using System.Collections.Generic;
using System.Reflection;
using UnityEngine;

public class ParseTimeLineRet {
    public string timeLineStr = null;
    public float SkillDuration = 0.0f;
}

public class GM_SkillMgr
{
    public static GM_SkillMgr Instance = null;

    // key  mainType + subKey;
    private Dictionary<int, Dictionary<string, MethodInfo>> skillModelSet;
    private Dictionary<int, List<SkillTimePoint>> allSkillTimeLine = new Dictionary<int, List<SkillTimePoint>>();
    private List<Type> allSkillConfigType = new List<Type>();

    public void Init() {
        GM_SkillMgr.Instance = this;
        this.skillModelSet = new Dictionary<int, Dictionary<string, MethodInfo>>();
        this.ScanAllSkillModelAndConfig();
    }

    private void ScaneOneSkillModel(Type t, SkillModel skillModel) {
        MethodInfo[] funcs = t.GetMethods(BindingFlags.Static | BindingFlags.Public | BindingFlags.NonPublic);
        for (int j = 0; j < funcs.Length; j++) {
            SkillProcesser p = funcs[j].GetCustomAttribute<SkillProcesser>();
            if (p == null) {
                continue;
            }

            int key = skillModel.mainType + p.subType; // ??????key, -1, 1000000 + (-1) 0999999
            Dictionary<string, MethodInfo> processFuncs = null;
            if (!this.skillModelSet.ContainsKey(key))
            {
                processFuncs = new Dictionary<string, MethodInfo>();
                this.skillModelSet.Add(key, processFuncs);
            }
            else { // key --->Init(if), Begin(else), End(else)
                processFuncs = this.skillModelSet[key];
            }

            processFuncs.Add(p.funcName, funcs[j]);
        }
    }

    private void ScaneOneSkillConfig(Type t, SkillConfig skillConfig)
    {
        this.allSkillConfigType.Add(t);
    }

    private void ScanAllSkillModelAndConfig() {
        Assembly[] assemblies = AppDomain.CurrentDomain.GetAssemblies();
        foreach (Assembly assembly in assemblies)
        {
            Type[] allTypes = assembly.GetTypes();
            for (int i = 0; i < allTypes.Length; i++)
            {
                Type t = allTypes[i];
                SkillModel skillModel = t.GetCustomAttribute<SkillModel>();
                if (skillModel != null)
                {
                    this.ScaneOneSkillModel(t, skillModel);
                }

                SkillConfig skillConfig = t.GetCustomAttribute<SkillConfig>();
                if (skillConfig != null)
                {
                    this.ScaneOneSkillConfig(t, skillConfig);
                }
            }
        }
    }

    private MethodInfo GetProcesserFunc(string funcName, Dictionary<string, MethodInfo> funMap, Dictionary<string, MethodInfo> defaultFunMap)
    {
        if (funMap.ContainsKey(funcName))
        {
            return funMap[funcName];
        }
        if (defaultFunMap.ContainsKey(funcName))
        {
            return defaultFunMap[funcName];
        }

        return null;
    }

    // ??Skill?????? TimePointList(excel);
    // ???????????????;
    private List<SkillTimePoint> ParserTimeLine(int skillId) {
        if (this.allSkillTimeLine.ContainsKey(skillId)) {
            return this.allSkillTimeLine[skillId];
        }

        int mainType = (int)(skillId / 1000000);
        int subType = skillId % 1000000;


        int key = mainType * 1000000;
        key = key - 1; // ??key;

        // ??funcMap?????????default??
        Dictionary<string, MethodInfo> funMap = null;
        Dictionary<string, MethodInfo> defaultFunMap = null;

        if (this.skillModelSet.ContainsKey(key)) {
            defaultFunMap = this.skillModelSet[key];
        }

        if (this.skillModelSet.ContainsKey(skillId)) {
            funMap = this.skillModelSet[skillId];
        }
        else {
            funMap = defaultFunMap;
        }
        if (funMap == null) {
            return null;
        }

        MethodInfo getTimeLineStr = this.GetProcesserFunc("TimeLine", funMap, defaultFunMap);
        if (getTimeLineStr == null) {
            return null;
        }

        object[] paramDatas = new object[] { skillId };
        ParseTimeLineRet ret = (ParseTimeLineRet) getTimeLineStr.Invoke(null, paramDatas);
        if (ret == null || ret.timeLineStr == null) {
            return null;
        }


        // ???????
        List<SkillTimePoint> timeLine = new List<SkillTimePoint>();
        timeLine.Add(new SkillTimePoint(0, GetProcesserFunc("Init", funMap, defaultFunMap)));
        timeLine.Add(new SkillTimePoint(0, GetProcesserFunc("Begin", funMap, defaultFunMap)));
        timeLine.Add(new SkillTimePoint(ret.SkillDuration * 0.5f, GetProcesserFunc("Calc", funMap, defaultFunMap)));
        timeLine.Add(new SkillTimePoint(ret.SkillDuration, GetProcesserFunc("End", funMap, defaultFunMap)));

        string[] results = ret.timeLineStr.Split('|');
        for (int i = 0; i < results.Length; i += 2) {
            if (results[i + 0].Equals("Init"))
            {
                timeLine[0].exceTime = float.Parse(results[i + 1]);
            }
            else if (results[i + 0].Equals("Begin"))
            {
                timeLine[1].exceTime = float.Parse(results[i + 1]);
            }
            else if (results[i + 0].Equals("Calc"))
            {
                timeLine[2].exceTime = float.Parse(results[i + 1]);
            }
            else if (results[i + 0].Equals("End"))
            {
                timeLine[3].exceTime = float.Parse(results[i + 1]);
            }
            else
            {
                MethodInfo func = GetProcesserFunc(results[i + 0], funMap, defaultFunMap);
                if (func != null) {
                    timeLine.Add(new SkillTimePoint(float.Parse(results[i + 1]), func));
                }

            }

        }

        this.allSkillTimeLine.Add(skillId, timeLine);
        return timeLine;
    }

    public List<SkillTimeNode> GetSkillTimeNode(int skillId) {
        List<SkillTimePoint> timePoints = this.ParserTimeLine(skillId);

        List<SkillTimeNode> ret = new List<SkillTimeNode>();
        for (int i = 0; i < timePoints.Count; i++)
        {
            ret.Add(new SkillTimeNode(timePoints[i])); // ?????
        }

        return ret;
    }

    // ?????????????? config,????Id;
    public object GetSkillConfig(int skillId)
    {
        object config = null;

        for (int i = 0; i < this.allSkillConfigType.Count; i++)
        {
            config = ExcelDataMgr.Instance.GetConfigData(this.allSkillConfigType[i], skillId.ToString());
            if (config != null)
            {
                return config;
            }
        }

        Debug.Log($"Get Skill Config {skillId} null!");
        return null;
    }
}
using System.Collections;
using System.Collections.Generic;
using UnityEngine;

[SkillModel(1000000)]
public class SkillAModel
{
    /*[SkillProcesser("MyCustom", 1)]
    public static void MyCostomProcesser_1000001(GM_Charactor sender, int skillId, object udata)
    {
        Debug.Log("MyCostomProcesser_1000001!");
    }*/

    [SkillProcesser("Init", -1)] // default;
    public static void DefaultInitProcesser(GM_Charactor sender, int skillId, object udata) {
        SkillAConfig config = ExcelDataMgr.Instance.GetConfigData<SkillAConfig>(skillId.ToString());
        if (!config.SkillEffectName.Equals("default"))
        {
            GM_EffectMgr.Instance.PlayerSkillEffectAt(config.SkillEffectName, sender.transform.parent, sender.transform.position);
        }
    }

    [SkillProcesser("Begin", -1)]
    public static void DefaultBeginProcesser(GM_Charactor sender, int skillId, object udata)
    {
        // Debug.Log($"DefaultBeginProcesser Skill ID: {skillId}");
    }

    [SkillProcesser("Calc", -1)]
    public static void DefaultCalcProcesser(GM_Charactor sender, int skillId, object udata)
    {
        Debug.Log($"DefaultCalcProcesser Skill ID: {skillId}");
        SkillAConfig config = ExcelDataMgr.Instance.GetConfigData<SkillAConfig>(skillId.ToString());
        FightCalcResult calcResult = new FightCalcResult();
        calcResult.attackR = config.AttackR;
        sender.CalcFightBuff("AttackR", calcResult); // sender 如果带N个buff,每个buff都有attackR,那么就可以都累加;

        GM_Charactor[] targets = FightMgr.Instance.FindTargetsInArea(sender, calcResult.attackR);
        int count = targets.Length;
        if (config.TargetMax > 0) {
            count = (count > config.TargetMax) ? config.TargetMax : count;
        }

        float attack = (float)sender.fightData.attack;
        attack = attack * config.DamageRate + config.FixDamage; // A类技能的模板;

        calcResult.attack = attack;
        // 叠加发送这所有Buff的Attack技能，不只是一个;
        sender.CalcFightBuff("Attack", calcResult);


        // 遍历所有的目标
        for (int i = 0; i < count; i++)
        {
            calcResult.defense = targets[i].fightData.defense;
            targets[i].CalcFightBuff("Defense", calcResult);

            if (calcResult.attack > calcResult.defense)
            {
                targets[i].OnLoseHp((int)(calcResult.attack - calcResult.defense));
            }
        }
    }

    [SkillProcesser("End", -1)]
    public static void DefaultEndProcesser(GM_Charactor sender, int skillId, object udata)
    {
        // Debug.Log($"DefaultEndProcesser Skill ID: {skillId}");
    }

    [SkillProcesser("TimeLine", -1)]
    public static ParseTimeLineRet DefaultTimeLineStr(int skillId)
    {
        ParseTimeLineRet ret = new ParseTimeLineRet();

        SkillAConfig config = ExcelDataMgr.Instance.GetConfigData<SkillAConfig>(skillId.ToString());
        if (config == null) {
            return null;
        }

        ret.SkillDuration = config.SkillDuration;
        ret.timeLineStr = config.TimeLine;

        return ret;
    }
}
using System;
using System.Collections;
using System.Collections.Generic;
using System.Reflection;
using UnityEngine;

public class GM_BuffMgr
{
    public static GM_BuffMgr Instance = null;
    private Dictionary<int, Dictionary<string, MethodInfo>> buffModelSet = null;
    private List<Type> allBuffConfigType = null;

    public void Init()
    {
        GM_BuffMgr.Instance = this;
        this.buffModelSet = new Dictionary<int, Dictionary<string, MethodInfo>>();
        this.allBuffConfigType = new List<Type>();
        this.ScanAllSkillModelAndConfig();
    }

    private void ScaneOneBuffModel(Type t, BuffModel buffModel)
    {
        MethodInfo[] funcs = t.GetMethods(BindingFlags.Static | BindingFlags.Public | BindingFlags.NonPublic);
        for (int j = 0; j < funcs.Length; j++)
        {
            BuffProcesser p = funcs[j].GetCustomAttribute<BuffProcesser>();
            if (p == null)
            {
                continue;
            }

            // Debug.Log(p.funcName);
            int key = buffModel.mainType + p.subType;

            Dictionary<string, MethodInfo> processFuncs = null;

            if (!this.buffModelSet.ContainsKey(key))
            {
                processFuncs = new Dictionary<string, MethodInfo>();
                this.buffModelSet.Add(key, processFuncs);
            }
            else
            {
                processFuncs = this.buffModelSet[key];
            }
            processFuncs.Add(p.propName, funcs[j]);
        }
    }

    private void ScaneOneBuffConfig(Type t, BuffConfig buffConfig)
    {
        this.allBuffConfigType.Add(t);
    }

    private void ScanAllSkillModelAndConfig()
    {
        Assembly[] assemblies = AppDomain.CurrentDomain.GetAssemblies();
        foreach (Assembly assembly in assemblies)
        {
            Type[] allTypes = assembly.GetTypes();
            for (int i = 0; i < allTypes.Length; i++)
            {
                Type t = allTypes[i];
                BuffModel buffModel = t.GetCustomAttribute<BuffModel>();
                if (buffModel != null)
                {
                    this.ScaneOneBuffModel(t, buffModel);
                }

                BuffConfig buffConfig = t.GetCustomAttribute<BuffConfig>();
                if (buffConfig != null)
                {
                    this.ScaneOneBuffConfig(t, buffConfig);
                }
            }
        }
    }

    private MethodInfo GetProcesserFunc(string funcName, Dictionary<string, MethodInfo> funMap, Dictionary<string, MethodInfo> defaultFunMap)
    {
        if (funMap.ContainsKey(funcName))
        {
            return funMap[funcName];
        }
        if (defaultFunMap.ContainsKey(funcName))
        {
            return defaultFunMap[funcName];
        }

        return null;
    }

    private MethodInfo GetProcesserFuncByBuffId(int buffId, string propName)
    {
        int mainType = (int)(buffId / 100000);
        int subType = buffId % 100000;

        int key = mainType * 100000;
        Dictionary<string, MethodInfo> funMap = null;
        Dictionary<string, MethodInfo> defaultFunMap = null;

        key = key - 1;
        if (this.buffModelSet.ContainsKey(key))
        {
            defaultFunMap = this.buffModelSet[key];
        }


        if (this.buffModelSet.ContainsKey(buffId))
        {
            funMap = this.buffModelSet[buffId];
        }
        else
        {
            funMap = defaultFunMap;
        }

        MethodInfo m = this.GetProcesserFunc(propName, funMap, defaultFunMap);

        return m;
    }

    public BuffNode CreateBuffNode(int buffId)
    {

        MethodInfo m = this.GetProcesserFuncByBuffId(buffId, "BuffTime");
        BuffNode node = new BuffNode(buffId);
        if (m != null)
        {
            m.Invoke(null, new object[] { node });
        }


        return node;
    }

    public void CalcFightBuffWithProp(int buffId, string propName, FightCalcResult ret) {
        MethodInfo m = this.GetProcesserFuncByBuffId(buffId, propName);
        if (m == null)
        {
            return;
        }

        object[] paramsData = new object[] { buffId, ret };
        m.Invoke(null, paramsData);
    }
}
using System.Collections;
using System.Collections.Generic;
using UnityEngine;

[BuffModel(100000)]
public class BuffAModel
{
    [BuffProcesser("BuffTime", -1)]
    public static void DefaultBuffTime(BuffNode node)
    {
        BuffAConfig config = ExcelDataMgr.Instance.GetConfigData<BuffAConfig>(node.buffId.ToString());
        if (config == null) {
            return;
        }

        node.freezeTime = config.BuffFrezzeTime;
        node.durationTime = config.BuffTime;
    }

    [BuffProcesser("Defense", -1)]
    public static void DefaultCalcPropDefense(int buffId, FightCalcResult ret) {
        BuffAConfig config = ExcelDataMgr.Instance.GetConfigData<BuffAConfig>(buffId.ToString());
        if (config == null)
        {
            return;
        }

        ret.defense = ret.defense * config.BuffDefense;
    }

    [BuffProcesser("Attack", -1)]
    public static void DefaultCalcPropAttack(int buffId, FightCalcResult ret) {
        BuffAConfig config = ExcelDataMgr.Instance.GetConfigData<BuffAConfig>(buffId.ToString());
        if (config == null)
        {
            return;
        }

        ret.attack = ret.attack * config.BuffAttack;
    }

    [BuffProcesser("AttackR", -1)]
    public static void DefaultCalcPropAttackR(int buffId, FightCalcResult ret)
    {
        Debug.Log("DefaultCalcPropAttackR Buff Cale !!!!!###");
    }
}


*********************************

**????????**

1. **`GameApp` ??????**
   - **????????**?`GameApp` ???????????????????? `GM_SkillMgr`?`GM_BuffMgr` ? `GM_EffectMgr`?????????? `Init()` ???? `GameApp.Instance` ???UI??????
   - **??????**?`EnterGame()` ????????UI???????????????????????????

   ```csharp
   public void Init() {
       GameApp.Instance = this;
       new GM_EffectMgr().Init();
       new GM_SkillMgr().Init();
       new GM_BuffMgr().Init();
       EventMgr.Instance.AddListener((int)GM_Event.UI, this.OnUIEventProc);
   }
   ```

2. **`FightMgr` ??????**
   - **??????**??????????????????? `LoadAndGotoMap()` ?????????????
   - **???Buff??**?`OnProcessSkill()` ? `OnProcessBuff()` ????????? `StartSkill` ? `StartBuff` ????????Buff????

   ```csharp
   public void LoadAndGotoMap(int mapId) {
       GameObject mapPrefab = ResMgr.Instance.LoadAssetSync<GameObject>($"Maps/Prefabs/{mapId}.prefab");
       var map = GameObject.Instantiate(mapPrefab);
       map.transform.SetParent(this.transform, false);
       // ???????
   }
   ```

3. **`GM_Charactor` ??????**
   - **?????????**???????????Buff???????????`StartSkill()` ???? `SkillTimeLine` ???????????
   - **Buff??????**??? `BuffTimeLine` ? `SkillTimeLine`???????????????Buff???

   ```csharp
   public void StartSkill(int skillId) {
       if (this.skillTimeLine.StartSkill(this, skillId, () => {
           this.ch.SetState(CharactorState.Idle);
       })) {
           this.ch.SetState(CharactorState.Attack);
       }
   }
   ```

4. **`SkillTimeLine` ??????**
   - **???????**??????????????? `SkillTimeNode` ? `SkillTimePoint` ?????????????? `Init`?`Begin`?`Calc` ? `End`??
   - **???????**?`OnUpdate()` ????????????????????????????????????

   ```csharp
   public void OnUpdate(float dt) {
       for (int i = 0; i < this.timelineNode.Count; i++) {
           if (this.timelineNode[i].runTime <= 0 && !this.timelineNode[i].isExced) {
               this.timelineNode[i].timePoint.exceProc.Invoke(null, paramData);
               this.timelineNode[i].isExced = true;
           }
       }
   }
   ```

5. **`GM_SkillMgr` ? `GM_BuffMgr` ?????**
   - **???Buff??**?`GM_SkillMgr` ?????????????`GM_BuffMgr` ????Buff????????????? `MethodInfo` ??????????????????Buff???
   - **???????**??? `ParserTimeLine()` ??????????????????????????????????

   ```csharp
   public List<SkillTimeNode> GetSkillTimeNode(int skillId) {
       List<SkillTimePoint> timePoints = this.ParserTimeLine(skillId);
       return timePoints.Select(tp => new SkillTimeNode(tp)).ToList();
   }
   ```

6. **?????????**
   - ??????`GameApp` ?????????
   - `FightMgr` ????????????????????
   - ?????????????? `EventMgr` ?????`FightMgr` ?? `GM_Charactor` ????Buff?????
   - `GM_Charactor` ??? `SkillTimeLine` ? `BuffTimeLine` ?????Buff??????
   - ?????? `OnUpdate`???????????Buff???

   *********************************

**????????**

1. **?????????**
   1. **`GameApp`??????**
      - ????????????????Buff??????
      - ?????????UI?????????Buff????
      - ??UI??????
      - **????**?`EnterGame()` ?? UI ?????????

   2. **`FightMgr`???????**
      - ???????????????
      - ?????????????????
      - ????? Buff ?????
      - **????**?`LoadAndGotoMap(int mapId)` ????????????????

   3. **`GM_Charactor`??????**
      - ???????????????? Buff ????
      - ???????? `Idle`?`Attack`?`Died`??
      - ????????? Buff?
      - **????**?`StartSkill(int skillId)` ???????????????

   4. **`SkillTimeLine`???????**
      - ???????????????????????????????????
      - ?????????????????
      - **????**?`OnUpdate(float dt)` ???????????????

   5. **`GM_SkillMgr`???????**
      - ????????????????????????
      - ????????????????????
      - **????**?`GetSkillTimeNode(int skillId)` ????????????????

2. **???????**
   1. **`GameApp` ??????????**
      - `GameApp` ???????????????UI?
      - `FightMgr` ????????????????????
      - `GM_Charactor` ????????????????????/ Buff ????
      - `SkillTimeLine` ? `BuffTimeLine` ??????? Buff ??????

3. **?????????**
   1. **???**?
      - `GameApp.Init()` ?????????? UI ???
      - `FightMgr.LoadAndGotoMap()` ?????????????????
   2. **??/Buff??**?
      - ?? `EventMgr` ????? UI ?????????????
      - `FightMgr.OnProcessSkill()` ?? `GM_Charactor.StartSkill()` ?????
   3. **????**?
      - `SkillTimeLine.StartSkill()` ????????????????????????????
      - `GM_Charactor` ?? `SkillTimeLine` ? `BuffTimeLine` ?????? Buff ????

**?????????**
```csharp
public void OnProcessSkill(int skillId)
{
    this.player.StartSkill(skillId); // ????????
}
```
? `OnProcessSkill` ????????? `StartSkill` ????????????????????????????????????????

*********************************

**Buff?Skill?????????**

1. **????**
   - **Skill????**????????????????????AI??????????????????????????????????????????????????????????????
   - **Buff???/???**?Buff????????????????????????????????????????????Buff???????????????????????????????

2. **???????**
   - **Skill?Buff???????????????????**?
     - **????**?
       - **Skill**????????AI???????
       - **Buff**?????????????????????????
     - **?????**?
       - **Skill**????????????????????????????
       - **Buff**?????????????????????????????????????
   - **????**?
     - `GM_SkillMgr` ? `GM_BuffMgr` ???????Buff????????????????????????????Buff?

3. **??????**
   - **???? (`SkillTimeLine` ? `GM_SkillMgr`)**
     - **`SkillTimeLine`** ???????????????????????
     - **`GM_SkillMgr`** ???????????????
     - ?? `StartSkill()` ???????? `OnUpdate()` ?????????????????????????????????

   - **????**?`SkillTimeLine`??`StartSkill`??
     ```csharp
     public bool StartSkill(GM_Charactor sender, int skillId, Action OnComplete)
     {
         if (this.isRunning) return false;

         List<SkillTimeNode> timeLine = GM_SkillMgr.Instance.GetSkillTimeNode(skillId);
         if (timeLine == null) return false;

         this.timelineNode = timeLine;
         this.isRunning = true;
         this.OnComplete = OnComplete;
         this.skillId = skillId;
         this.sender = sender;
         return true;
     }
     ```

   - **Buff?? (`BuffTimeLine` ? `GM_BuffMgr`)**
     - **`BuffTimeLine`** ?? Buff ??????????????????
     - **`GM_BuffMgr`** ?? Buff ??????????? Buff ??????????
     - ?? `StartBuff()` ?? Buff???? `CalcFightBuff()` ??? Buff ?????????

   - **????**?`BuffTimeLine`??`StartBuff`??
     ```csharp
     public void StartBuff(int buffId)
     {
         if (this.buffTimeLine.StartBuff(buffId))
         {
             // ??UI?Buff???
             EventMgr.Instance.Emit((int)GM_Event.UI, UIEvent.BuffOpened);
         }
     }
     ```

4. **?????????**
   - **???Buff?????????????**?
     - **?? (`GM_SkillMgr`)**??????? `SkillProcesser` ????????????????
     - **Buff (`GM_BuffMgr`)**??????? `BuffProcesser` ????????Buff??????

   - **??????**?`GM_SkillMgr`??????????
     ```csharp
     MethodInfo func = GetProcesserFunc("Calc", funMap, defaultFunMap);
     func.Invoke(null, new object[] { sender, skillId, udata });
     ```

   - **Buff????**?`GM_BuffMgr`???Buff?????
     ```csharp
     MethodInfo m = this.GetProcesserFuncByBuffId(buffId, "Defense");
     m.Invoke(null, new object[] { buffId, ret });
     ```

**???**
- **????**?????????? `StartSkill()` ???? Buff ??? `StartBuff()` ????????
- **?????**?????????????????Buff ????????????????????
- **????**???? Buff ???? `GM_SkillMgr` ? `GM_BuffMgr` ??????????????????????????

*********************************

???????**Skill???????????**??**Buff???/?????????????**????????????????????????????

### 1. **Skill??????????????**

??????????????????????? `SkillTimeLine` ?? `isRunning` ???????`isRunning` ????????????????????????????????????????

#### **?????**

? `SkillTimeLine` ?? `StartSkill` ???`isRunning` ???? `true`???????????????????????????????????? `false`??????????

```csharp
public struct SkillTimeLine
{
    private bool isRunning; // ?????????????

    public bool StartSkill(GM_Charactor sender, int skillId, Action OnComplete)
    {
        if (this.isRunning) // ????????????????????
        {
            return false; // ??????????
        }

        // ??????
        this.timelineNode = GM_SkillMgr.Instance.GetSkillTimeNode(skillId);
        if (timelineNode == null) return false;

        this.isRunning = true; // ??????true?????????
        this.sender = sender;
        this.skillId = skillId;
        this.OnComplete = OnComplete;

        return true; // ??true????????
    }

    public void OnUpdate(float dt)
    {
        if (!isRunning || timelineNode == null) return;

        // ???????????
        bool endFlag = true;
        for (int i = 0; i < timelineNode.Count; i++)
        {
            // ??????????????
            if (timelineNode[i].isExced) continue;

            // ????????????????
            timelineNode[i].runTime -= dt;
            if (timelineNode[i].runTime <= 0)
            {
                timelineNode[i].isExced = true;
                // ????????????
                timelineNode[i].timePoint.exceProc.Invoke(null, new object[] { sender, skillId });
            }

            endFlag = false; // ????????????????
        }

        if (endFlag) // ?????????????
        {
            isRunning = false; // ??????????????
            OnComplete?.Invoke();
        }
    }
}
```

#### **???**?
- **`isRunning`**????????????????????????`isRunning` ??? `true`??????????????????????? `isRunning` ??? `false`???????????
- **?????**???? `StartSkill` ????? `isRunning`??????????????

### 2. **Buff???/??????????????**

??????Buff ?????? Buff ????????Buff ??????? `BuffTimeLine` ? `BuffTimeNode` ??Buff?????? Buff ?????????????

#### **?????**

? `BuffTimeLine` ? `GM_BuffMgr` ??Buff ????? `isRunning` ??????????????????? Buff ?????????????????? Buff ?????????????????????? `CalcFightBuff` ?????

```csharp
public class GM_Charactor : MonoBehaviour
{
    public BuffTimeLine buffTimeLine;

    public void StartBuff(int buffId)
    {
        // ???? Buff ????
        if (this.buffTimeLine.StartBuff(buffId)) // ?? Buff ????
        {
            // ?? UI?Buff ???
            EventMgr.Instance.Emit((int)GM_Event.UI, UIEvent.BuffOpened);
        }
    }
}
```

`BuffTimeLine` ????????? `isRunning` ?????? Buff ??????????????????

#### **BuffTimeLine?Buff???????**
```csharp
public class BuffTimeLine
{
    private List<BuffNode> activeBuffs; // ???????Buff??

    public bool StartBuff(int buffId)
    {
        BuffNode newBuff = GM_BuffMgr.Instance.CreateBuffNode(buffId);
        activeBuffs.Add(newBuff); // ??Buff?????????Buff??
        return true;
    }

    public void CalcAllBuffsWithProp(string propName, FightCalcResult ret)
    {
        // ????????Buff????????????
        foreach (var buff in activeBuffs)
        {
            GM_BuffMgr.Instance.CalcFightBuffWithProp(buff.buffId, propName, ret);
        }
    }
}
```

#### **???**?
- **`activeBuffs` ??**??? Buff ??????????????? `activeBuffs` ?????????? Buff ?????????????????
- **`CalcAllBuffsWithProp()`**??????????????? Buff????????????? Buff ?????????

### 3. **??**

- **Skill ???????**??? `SkillTimeLine` ?? `isRunning` ?????????????????????????????????????
- **Buff ????????**?`BuffTimeLine` ???????????? Buff ?? `activeBuffs` ???????????????????? `activeBuffs`??? Buff ??????????????


*********************************

**Skill?Buff??????????????**

?????????**Skill** ? **Buff** ????????????
- **Skill** ?????????????????
- **Buff** ??????????????????????

?????????????????????

### 1. Skill???????

**Skill** ???????? `SkillTimeLine` ??? **`isRunning`** ??? `StartSkill()` ???`SkillTimeLine` ????????????????????????

- **`SkillTimeLine` ???**?
  - `isRunning` ????????????????????????
  - ? `isRunning` ? `true` ??`StartSkill()` ??????? `false`????????????

**????**?
```csharp
public struct SkillTimeLine {
    private List<SkillTimeNode> timelineNode; // ?????????
    public GM_Charactor sender;
    public int skillId;
    private bool isRunning; // ??????????
    private Action OnComplete; // ???????

    public void Init() {
        this.timelineNode = null;
        this.isRunning = false;
        this.sender = null;
        this.skillId = 0;
    }

    public bool StartSkill(GM_Charactor sender, int skillId, Action OnComplete)
    {
        if (this.isRunning) {
            return false; // ????????????false
        }
        this.timelineNode = null;

        List<SkillTimeNode> timeLine = GM_SkillMgr.Instance.GetSkillTimeNode(skillId);
        if (timeLine == null) {
            return false;
        }

        this.timelineNode = timeLine;
        this.isRunning = true; // ???????????
        this.OnComplete = OnComplete;
        this.skillId = skillId;
        this.sender = sender;

        return true;
    }

    public void OnUpdate(float dt) {
        if (this.isRunning == false) {
            return;
        }

        // ??????????????
        bool endFlag = true;
        for (int i = 0; i < this.timelineNode.Count; i++) {
            if (this.timelineNode[i].isExced) {
                continue;
            }

            this.timelineNode[i].runTime -= dt;
            if (this.timelineNode[i].runTime <= 0) {
                this.timelineNode[i].isExced = true;

                object[] paramData = new object[] { this.sender, this.skillId, this.timelineNode[i].udata };
                this.timelineNode[i].timePoint.exceProc.Invoke(null, paramData);
            }

            endFlag = false;
        }

        if (endFlag) {
            this.isRunning = false; // ??????????????????????????
            this.timelineNode = null;
            this.OnComplete?.Invoke();
        }
    }
}
```

**??**?
- **`isRunning`**?????????????????? `isRunning` ? `true` ???????????
- **`OnUpdate()`**????????????????? `isRunning` ??? `false`??????????????

### 2. Buff????????

**Buff** ????????? Buff ????????????? `BuffTimeLine` ? `GM_BuffMgr` ?????? Buff ???????? Buff?

- **`BuffTimeLine`** ???????
  - `BuffTimeLine` ???? `List<BuffNode>` ?????????????? Buff?
  - ? `StartBuff()` ???????? Buff ????? `List<BuffNode>` ???????????? Buff?

**????**??? `BuffTimeLine` ??????????
```csharp
public class BuffTimeLine {
    private List<BuffNode> activeBuffs; // ???????Buff

    public void Init() {
        this.activeBuffs = new List<BuffNode>();
    }

    public bool StartBuff(int buffId) {
        BuffNode newBuff = GM_BuffMgr.Instance.CreateBuffNode(buffId);
        if (newBuff == null) {
            return false;
        }
        this.activeBuffs.Add(newBuff); // ??Buff????Buff???
        return true;
    }

    public void OnUpdate(float dt) {
        for (int i = 0; i < activeBuffs.Count; i++) {
            BuffNode buff = activeBuffs[i];
            buff.Update(dt);
            if (buff.IsExpired()) {
                activeBuffs.RemoveAt(i);
                i--;
            }
        }
    }
}
```

**??**?
- **`activeBuffs` ??**???????? Buff????? Buff ?????????????
- **`StartBuff()`**????????? Buff ????? `activeBuffs` ????????????? Buff?
- **`OnUpdate()`**??????? Buff??????????????????????

### ???Skill?Buff?????
1. **Skill?????**??? `SkillTimeLine` ?? `isRunning` ?????????????????????????????????????
   - ?????`SkillTimeLine.StartSkill()` ???? `isRunning` ???

2. **Buff?????**?`BuffTimeLine` ?????? `List<BuffNode>` ???????? Buff ???????????
   - ?????`BuffTimeLine.StartBuff()` ???? `activeBuffs.Add(newBuff)` ?? Buff ????? Buff ????

???????????? Skill ? Buff ??????????????Skill ?????? Buff ?????????????????????????????

